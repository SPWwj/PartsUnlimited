@using PartsUnlimited.ViewModels
@using PartsUnlimited.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection; 
@using Microsoft.AspNetCore.Components.Web

@inject ShoppingCartNotificationService Notifications
@inherits OwningComponentBase<IPartsUnlimitedContext>
<div id="shopping-cart-page">
    <section>
        <h2>Review your Cart</h2>
        @if (Model.CartCount > 0)
        {
            <div id="cart-summary">
                <div class="hidden-xs cart-summary-header">
                    <div class="row">
                        <div class="col-sm-8 col-md-8 no-gutter-md-left no-gutter-sm-left">Product Description</div>
                        <div class="col-sm-2 col-md-2 text-center">Quantity</div>
                        <div class="col-sm-2 col-md-2 text-center">Price</div>
                    </div>
                </div>

                @foreach (var item in Model.CartItems)
                {
                    <div id="row-@item.CartItemId" class="cart-item">
                        <div class="row">
                            <div class="col-xs-1 no-gutter-xs-right text-center-xs col-sm-2 col-sm-push-8 text-center-sm">
                                <div class="item-label item-inventory">@item.Count</div>
                            </div>
                            <div class="col-xs-3 col-sm-3 col-sm-pull-2 col-md-2"><img src="/images/@item.Product.ProductArtUrl" /></div>
                            <div class="col-xs-6 col-sm-2 col-sm-push-5 text-center-sm col-md-push-6">
                                <div class="visible-xs item-label">@item.Product.Title</div>
                                <div class="item-price">@item.Product.Price.ToString("C")</div>
                            </div>
                            <div class="visible-xs col-xs-2 text-right no-gutter-xs-left">
                                <button class="remove-link" @onclick="() => RemoveFromCart(item.CartItemId)">
                                    <img src="/images/remove_icon.png" />
                                </button>
                            </div>
                            <div class="col-xs-12 col-sm-5 col-sm-pull-4 col-md-6 description">
                                <div class="hidden-xs">
                                    <strong><a href="@string.Format(_productDetailslinkTemplate, item.ProductId)">@item.Product.Title</a></strong>
                                </div>
                                <div class="visible-xs item-label">Description</div>
                                <p class="text-content">@item.Product.Description</p>
                            </div>
                            <div class="hidden-xs remove-cart-item">
                                <button @onclick="() => RemoveFromCart(item.CartItemId)" class="remove-link btn">
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                }

                <OrderCostSummaryWidget Model="Model.OrderCostSummary" />
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-sm-offset-6 col-md-4 col-md-offset-8">
                        <div>
                            <a href="@Checkout" class="btn pull-right checkout">Checkout</a>
                        </div>
                    </div>
                </div>
            </div>
        }
        @if (Model.CartCount <= 0)
        {
            <h4 id="empty-cart">
                Your cart is currently empty
            </h4>
        }
    </section>
</div>
@code {
    [Parameter] public ShoppingCartViewModel2 Model { get; set; }

    [Parameter] public string Checkout { get; set; }

    [Parameter] public string DetailsTemplate { get; set; }

    [Parameter] public string ShoppingCartId { get; set; }

    private string _productDetailslinkTemplate = null;

    protected override void OnInitialized()
    {
        _productDetailslinkTemplate = DetailsTemplate.Replace("$0", "{0}");
    }

    public async Task RemoveFromCart(int id)
    {
        using var context = ScopedServices.GetRequiredService<IPartsUnlimitedContext>();
        var cart = new ShoppingCart(context, ShoppingCartId);
        // Get the name of the album to display confirmation
        var cartItem = await context.CartItems
            .Where(item => item.CartItemId == id)
            .Include(c => c.Product)
            .SingleOrDefaultAsync();

        int itemCount;
        if (cartItem != null)
        {
            // Remove from cart
            itemCount = cart.RemoveFromCart(id);

            await context.SaveChangesAsync(default);

            var item = Model.CartItems.Single(c => c.CartItemId == id);
            if (itemCount == 0)
            {
                Model.CartItems.Remove(item);
            }
            else
            {
                item.Count--;
            }
        }
        else
        {
            itemCount = 0;
        }

        Model.OrderCostSummary.CartTotal = cart.GetTotal().ToString();
        // Display the confirmation message

        var items = Model.CartItems;
        var itemsCount = items.Sum(x => x.Count);
        var subTotal = items.Sum(x => x.Count * x.Product.Price);
        var shipping = itemsCount * (decimal)5.00;
        var tax = (subTotal + shipping) * (decimal)0.05;
        var total = subTotal + shipping + tax;

        Model.OrderCostSummary = new OrderCostSummary
        {
            CartSubTotal = subTotal.ToString("C"),
            CartShipping = shipping.ToString("C"),
            CartTax = tax.ToString("C"),
            CartTotal = total.ToString("C")
        };

        await Notifications.OnItemRemoved();
        //var results = new ShoppingCartRemoveViewModel
        //{
        //    Message = message,
        //    CartTotal = cart.GetTotal().ToString(),
        //    CartCount = cart.GetCount(),
        //    ItemCount = itemCount,
        //    DeleteId = id
        //};
    }
}
